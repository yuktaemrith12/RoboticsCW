<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SortiFy ‚Äî Office Robot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="app">

  <!-- ========================== SIDEBAR ==================================== -->
  <aside class="sidebar">
    <div class="brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="SortiFy" class="brand-logo">
      <span class="brand-name">SortiFy</span>
    </div>

    <nav class="nav">
      <a class="nav-item active" href="#project">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-journals" viewBox="0 0 16 16">
          <path d="M5 0h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2 2 2 0 0 1-2 2H3a2 2 0 0 1-2-2h1a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1H1a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v9a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1H3a2 2 0 0 1 2-2"/>
          <path d="M1 6v-.5a.5.5 0 0 1 1 0V6h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V9h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 2.5v.5H.5a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1H2v-.5a.5.5 0 0 0-1 0"/>
        </svg>
        <span>THE PROJECT</span>
      </a>
      <a class="nav-item" href="#classification">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-boxes" viewBox="0 0 16 16">
        <path d="M7.752.066a.5.5 0 0 1 .496 0l3.75 2.143a.5.5 0 0 1 .252.434v3.995l3.498 2A.5.5 0 0 1 16 9.07v4.286a.5.5 0 0 1-.252.434l-3.75 2.143a.5.5 0 0 1-.496 0l-3.502-2-3.502 2.001a.5.5 0 0 1-.496 0l-3.75-2.143A.5.5 0 0 1 0 13.357V9.071a.5.5 0 0 1 .252-.434L3.75 6.638V2.643a.5.5 0 0 1 .252-.434zM4.25 7.504 1.508 9.071l2.742 1.567 2.742-1.567zM7.5 9.933l-2.75 1.571v3.134l2.75-1.571zm1 3.134 2.75 1.571v-3.134L8.5 9.933zm.508-3.996 2.742 1.567 2.742-1.567-2.742-1.567zm2.242-2.433V3.504L8.5 5.076V8.21zM7.5 8.21V5.076L4.75 3.504v3.134zM5.258 2.643 8 4.21l2.742-1.567L8 1.076zM15 9.933l-2.75 1.571v3.134L15 13.067zM3.75 14.638v-3.134L1 9.933v3.134z"/>
      </svg>
        <span>CLASSIFICATION</span>
      </a>
      <a class="nav-item" href="#detection">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-bounding-box" viewBox="0 0 16 16">
          <path d="M1.5 1a.5.5 0 0 0-.5.5v3a.5.5 0 0 1-1 0v-3A1.5 1.5 0 0 1 1.5 0h3a.5.5 0 0 1 0 1zM11 .5a.5.5 0 0 1 .5-.5h3A1.5 1.5 0 0 1 16 1.5v3a.5.5 0 0 1-1 0v-3a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 1-.5-.5M.5 11a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 1 0 1h-3A1.5 1.5 0 0 1 0 14.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a1.5 1.5 0 0 1-1.5 1.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 1 .5-.5"/>
          <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm8-9a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
        </svg>
        <span>DETECTION</span>
      </a>
    </nav>
  </aside>


  <!-- ============================= PROJECT CONTENT ============================== -->
  <main class="content">

    <!-- ===== Project ===== -->
    <section id="project" class="section">
      <div class="card hero">
        <div class="hero-inner">
          <img class="hero-badge" src="{{ url_for('static', filename='hero-badge.png') }}" alt="">
          <div class="hero-body">
            <h1 class="title">SortiFy ‚Äî Your Intelligent Desk Assistant</h1>
            <p class="lead">
              This project showcases an AI-powered robotic system designed to automatically find, classify, and organize office desk items using computer vision and deep learning.
              The software integrates object classification and detection models (ResNet-50 and YOLOv8) trained on a custom dataset of common office items such as pens, mugs, notebooks, and keyboards.
              The system operates through a camera‚Äìrobot integration workflow: the RGB-D camera captures the desk scene, the trained model identifies each item, and the robotic arm plans and executes a grasp to move it to its designated location.
              Users can view real-time predictions through the interface, showing bounding boxes, detected object names, and confidence levels. The concept demonstrates how artificial intelligence, when combined with robotics, can bring automation into everyday environments ‚Äî turning a cluttered workspace into an organized one with minimal human input.
            </p>
          </div>
        </div>
      </div>

      <!-- Team Card -->
      <div class="card team">
        <div class="team-label"><span>Bit Byte Theory</span></div>
        <h2 class="card-title center">The Team</h2>
        <ul class="team-grid">
          <li class="member"><div class="avatar">üë©üèΩ‚Äçüíª</div><div class="name">Yukta Emrith</div></li>
          <li class="member"><div class="avatar">üë®üèΩ‚Äçüíª</div><div class="name">Kevan Chinapul</div></li>
          <li class="member"><div class="avatar">üë®üèª‚Äçüíª</div><div class="name">Rohaj Gokool Oopadhya</div></li>
        </ul>
      </div>
    </section>

    <!-- ====================== CLASSIFICATION =========================== -->

    <section id="classification" class="section">
      <div class="card">
        <h2 class="card-title center">Office Item Classifier</h2>

        <!-- Tabs -->
        <div class="tabs" role="tablist" aria-label="Input mode">
          <button id="tab-upload" class="tab active" role="tab" aria-selected="true" onclick="switchTab('upload')">Upload Image</button>
          <button id="tab-webcam" class="tab" role="tab" aria-selected="false" onclick="switchTab('webcam')">Use Webcam</button>
        </div>

        <!-- Upload Panel -->
        <div id="panel-upload" class="panel">
          <p class="hint center">Choose an image and submit to classify.</p>

          <!--Form submits via JS (no page refresh) -->
          <form id="upload-form" class="uploader" action="/predict" method="post" enctype="multipart/form-data">
            <div class="preview">
              <img id="image-preview" class="hidden" alt="Image Preview">
              <span id="preview-placeholder" class="muted">Image Preview</span>
            </div>

            <div class="row center gap">
              <label for="file-upload" class="btn ghost">Choose File</label>
              <input id="file-upload" name="file" type="file" accept="image/*" onchange="previewImage()" hidden required>
              <button class="btn primary" type="submit">Classify Image</button>
            </div>
          </form>

          <!-- Result Display -->
          <div id="upload-result" class="result hidden"></div>

          <!-- Server-rendered fallback -->
          {% if prediction %}
          <div class="result">
            <div class="result-row">
              {% if uploaded_preview %}
                <img class="thumb" src="{{ uploaded_preview }}" alt="Uploaded preview">
              {% endif %}
              <div>
                <h3 class="result-title">Prediction: <strong>{{ prediction }}</strong></h3>
                <p class="muted">Confidence: {{ confidence }}%</p>
              </div>
            </div>

            {% if other_predictions %}
            <div class="other-results">
              <h4>Other Possibilities</h4>
              {% for item in other_predictions %}
              <div class="other-item">
                <span>{{ item.class }}</span>
                <span>{{ item.confidence }}%</span>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>

        <!-- Webcam Panel -->
        <div id="panel-webcam" class="panel hidden">
          <p class="hint center">Click ‚ÄúStart Webcam‚Äù then ‚ÄúCapture &amp; Predict‚Äù.</p>
          <div class="preview" id="webcam-preview">
            <video id="video" class="hidden" autoplay playsinline></video>
            <canvas id="webcam-canvas" class="hidden"></canvas>
            <span id="video-placeholder" class="muted">Webcam Preview</span>
          </div>

          <div class="row center gap">
            <button class="btn" id="start-btn" onclick="startWebcam()">Start Webcam</button>
            <button class="btn warn" id="capture-btn" onclick="captureAndPredict()" disabled>Capture &amp; Predict</button>
            <button class="btn" id="stop-btn" onclick="stopWebcam()" disabled>Stop</button>
          </div>

          <div id="webcam-result" class="result hidden"></div>
        </div>
      </div>
    </section>

    <!-- ============================== DETECTION ================================== -->

    <section id="detection" class="section">
      <div class="card">
        <h2 class="card-title center">Office Item Detector</h2>
        <p class="hint center">Click ‚ÄúStart Webcam‚Äù to view live detection. Click ‚ÄúStop Webcam‚Äù to pause the stream.</p>

        <div class="detector">
          <div class="preview" id="detector-preview">
            <img id="detector-stream" class="hidden" alt="Live detection stream">
            <span id="detector-placeholder" class="muted">Detection Stream</span>
          </div>

          <div class="row center gap">
            <button class="btn primary" id="detector-start" onclick="startDetection()">Start Webcam</button>
            <button class="btn" id="detector-stop" onclick="stopDetection()" disabled>Stop Webcam</button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- ===== Scripts ===== -->
   
  <script>
    // Sidebar active state on scroll
    const sections = ['project','classification','detection'];
    const navItems = document.querySelectorAll('.nav-item');
    const onScroll = () => {
      let active = sections[0];
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (el && window.scrollY + 300 >= el.offsetTop) active = id;
      });
      navItems.forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#' + active));
    };
    window.addEventListener('scroll', onScroll);

    // Tabs
    function switchTab(which){
      const isUpload = which === 'upload';
      document.getElementById('panel-upload').classList.toggle('hidden', !isUpload);
      document.getElementById('panel-webcam').classList.toggle('hidden', isUpload);
      document.getElementById('tab-upload').classList.toggle('active', isUpload);
      document.getElementById('tab-webcam').classList.toggle('active', !isUpload);
    }

    // Upload preview
    function previewImage() {
      const input = document.getElementById('file-upload');
      const img = document.getElementById('image-preview');
      const ph  = document.getElementById('preview-placeholder');

      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          img.src = e.target.result;
          img.classList.remove('hidden');
          ph.classList.add('hidden');
        };
        reader.readAsDataURL(input.files[0]);
      } else {
        img.src = '';
        img.classList.add('hidden');
        ph.classList.remove('hidden');
      }
    }

    // Submit upload via fetch (no refresh)
    const uploadForm = document.getElementById('upload-form');
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById('file-upload');
      if (!fileInput.files || !fileInput.files[0]) {
        alert('Please choose an image first.');
        return;
      }

      const formData = new FormData(uploadForm);
      formData.append('ajax', '1'); // lets backend know to send JSON

      // Small loading state
      const box = document.getElementById('upload-result');
      box.classList.remove('hidden');
      box.innerHTML = `<div class="result-row"><div><h3 class="result-title">Predicting‚Ä¶</h3><p class="muted">Please wait</p></div></div>`;

      try {
        const res = await fetch('/predict', {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!res.ok) {
          const err = await res.json().catch(()=>({error:'Request failed'}));
          box.innerHTML = `<h3>Error</h3><p>${err.error || 'Unknown error'}</p>`;
          return;
        }

        const data = await res.json();
        renderResultInto(box, data.uploaded_preview, data.prediction, data.confidence, data.other_predictions);
      } catch (err) {
        box.innerHTML = `<h3>Error</h3><p>${err.message || err}</p>`;
      }
    });

    // Helper: render a result card matching the existing template
    function renderResultInto(container, thumbSrc, prediction, confidence, otherList){
      container.innerHTML = '';
      const row = document.createElement('div');
      row.className = 'result-row';

      if (thumbSrc) {
        const thumb = document.createElement('img');
        thumb.className = 'thumb';
        thumb.src = thumbSrc;
        row.appendChild(thumb);
      }

      const text = document.createElement('div');
      text.innerHTML = `<h3 class="result-title">Prediction: <strong>${prediction}</strong></h3>
                        <p class="muted">Confidence: ${confidence}%</p>`;
      row.appendChild(text);
      container.appendChild(row);

      if (otherList && otherList.length){
        const other = document.createElement('div');
        other.className = 'other-results';
        other.innerHTML = `<h4>Other Possibilities</h4>` +
          otherList.map(it =>
            `<div class="other-item"><span>${it.class}</span><span>${it.confidence}%</span></div>`
          ).join('');
        container.appendChild(other);
      }
    }

    // Webcam logic
    let stream = null;

    async function startWebcam(){
      const video = document.getElementById('video');
      const ph    = document.getElementById('video-placeholder');
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        video.classList.remove('hidden');
        ph.classList.add('hidden');
        document.getElementById('capture-btn').disabled = false;
        document.getElementById('stop-btn').disabled = false;
        document.getElementById('start-btn').disabled = true;
      }catch(err){
        alert('Could not access webcam: ' + err.message);
      }
    }

    function stopWebcam(){
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      document.getElementById('video').classList.add('hidden');
      document.getElementById('video-placeholder').classList.remove('hidden');
      document.getElementById('capture-btn').disabled = true;
      document.getElementById('stop-btn').disabled = true;
      document.getElementById('start-btn').disabled = false;
    }

    async function captureAndPredict(){
      const video = document.getElementById('video');
      if(!stream || video.readyState !== 4){
        alert('Webcam not ready yet.');
        return;
      }

      const canvas = document.getElementById('webcam-canvas');
      const ctx = canvas.getContext('2d');
      const w = video.videoWidth, h = video.videoHeight;
      canvas.width = w; canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);

      const dataURL = canvas.toDataURL('image/png');

      const res = await fetch('/predict', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ image_data: dataURL })
      });

      const box = document.getElementById('webcam-result');
      box.classList.remove('hidden');

      if(!res.ok){
        const err = await res.json().catch(()=>({error:'Request failed'}));
        box.innerHTML = `<h3>Error</h3><p>${err.error || 'Unknown error'}</p>`;
        return;
      }

      const data = await res.json();


      // Build webcam result card
      box.innerHTML = '';
      const row = document.createElement('div');
      row.className = 'result-row';

      const thumb = document.createElement('img');
      thumb.className = 'thumb';
      thumb.src = dataURL;

      const text = document.createElement('div');
      text.innerHTML = `<h3 class="result-title">Prediction: <strong>${data.prediction}</strong></h3>
                        <p class="muted">Confidence: ${data.confidence}%</p>`;

      row.appendChild(thumb);
      row.appendChild(text);
      box.appendChild(row);

      if (data.other_predictions && data.other_predictions.length){
        const other = document.createElement('div');
        other.className = 'other-results';
        other.innerHTML = `<h4>Other Possibilities</h4>` +
          data.other_predictions.map(it =>
            `<div class="other-item"><span>${it.class}</span><span>${it.confidence}%</span></div>`
          ).join('');
        box.appendChild(other);
      }
    }


    // --- Detection live stream toggle (client-side) ---
    let detectorActive = false;

    function startDetection(){
      const img = document.getElementById('detector-stream');
      const ph  = document.getElementById('detector-placeholder');

      // cache-bust so a fresh MJPEG stream starts
      img.src = '/video_feed?ts=' + Date.now();

      // when first frame arrives, swap placeholder for stream
      img.onload = () => {
        img.classList.remove('hidden');
        ph.classList.add('hidden');
      };

      // button states
      document.getElementById('detector-start').disabled = true;
      document.getElementById('detector-stop').disabled  = false;
      detectorActive = true;
    }

    function stopDetection(){
      const img = document.getElementById('detector-stream');
      img.src = '';                             // stop fetching the MJPEG stream
      img.classList.add('hidden');
      document.getElementById('detector-placeholder').classList.remove('hidden');

      document.getElementById('detector-start').disabled = false;
      document.getElementById('detector-stop').disabled  = true;
      detectorActive = false;
    }

    // Stop stream when navigating away
    window.addEventListener('beforeunload', () => {
      if (detectorActive) stopDetection();
    });


  </script>
</body>
</html>
